version: 2.1

orbs:
  aws-ecr: orbies/aws-ecr@1.2.1
  aws-ecr-circle: circleci/aws-ecr@9.0.4
  helm: circleci/helm@3.0.2
  aws-eks: circleci/aws-eks@2.2.0

jobs:
  build_test:
    working_directory: ~/repo
    docker:
    - image: cimg/go:1.21.6
    parallelism: 4
    resource_class: large
    steps:
    - checkout
    - restore_cache:
        keys:
        - go-mod-v4-{{ checksum "go.sum" }}
    - run:
        name: Install Dependencies
        command: go get ./...
    - save_cache:
        key: go-mod-v4-{{ checksum "go.sum" }}
        paths:
        - "/go/pkg/mod"
    - run:
        name: Run tests
        command: go list ./... | circleci tests run --command "xargs gotestsum --junitfile tmp/unit-tests.xml --format testname --" --split-by=timings --timings-type=name
    - store_test_results:
        path: ./tmp/test-results

  delete_helm_release:
    docker:
    - image: cimg/go:1.21.6
    parameters:
      cluster-name:
        description: Cluster name
        type: string
    steps:
    - aws-eks/update-kubeconfig-with-authenticator:
        cluster-name: << parameters.cluster-name >>
    - helm/delete_helm_release:
        helm_version: v3.2.4
        release_name: grafana-release
        timeout: 600s
  install_helm_chart:
    docker:
    - image: cimg/go:1.21.6
    parameters:
      cluster-name:
        description: Cluster name
        type: string
    steps:
    - aws-eks/update-kubeconfig-with-authenticator:
        cluster-name: << parameters.cluster-name >>
    - helm/install_helm_chart:
        add_repo: "${AWS_ECR_HELM_REPO_NAME}"
        chart: stable/grafana
        helm_version: v3.2.4
        release_name: grafana-release


workflows:
  build_and_test_deploy:
    jobs:
    - build_test
    - aws-ecr-circle/build_and_push_image:
        filters:
          branches:
            only:
            - main
        context: aws-dev
        create-repo: true
        dockerfile: Dockerfile
        path: .
        repo: "services-project-ops"
        tag: "latest"
        requires:
        - build_test

    - aws-ecr/push-helm-chart:
        filters:
          branches:
            only:
            - main
        account-url: AWS_ECR_ACCOUNT_URL
        aws-access-key-id: AWS_ACCESS_KEY_ID
        aws-secret-access-key: AWS_SECRET_ACCESS_KEY
        create-repo: false
        path: ./charts
        region: AWS_DEFAULT_REGION
        repo: "${AWS_ECR_HELM_REPO_NAME}"
        tag: 1.0.0
        requires:
        - aws-ecr-circle/build_and_push_image
    - install_helm_chart:
        filters:
          branches:
            only:
            - main
        cluster-name: test-cluster
    - delete_helm_release:
        filters:
          branches:
            only:
            - main
        cluster-name: test-cluster
        requires:
        - install_helm_chart
    - aws-eks/delete-cluster:
        filters:
          branches:
            only:
            - main
        cluster-name: test-cluster
        requires:
        - delete_helm_release
        wait: true
